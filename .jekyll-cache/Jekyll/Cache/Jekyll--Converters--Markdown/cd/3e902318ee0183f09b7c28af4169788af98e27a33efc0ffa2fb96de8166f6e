I"8<p>ì‚¬ê±´ì˜ ë°œë‹¨ì€ webflux ë¡œì˜ ì „í™˜ì´ì—ˆë‹¤. Aì„œë²„ -&gt; Bì„œë²„ ì˜ api íë¦„ì„ ê°€ì§€ëŠ” ì‹œìŠ¤í…œì—ì„œ Aì„œë²„ë¥¼ ì›¹í”ŒëŸ­ìŠ¤ë¡œ ì „í™˜í•˜ì—¬ cpu usage ë° Bì„œë²„ í˜¸ì¶œ ë³‘ë ¬ì²˜ë¦¬ë¡œ response time ì„ ì ˆì•½í•˜ë ¤ëŠ” ì·¨ì§€ì˜€ìœ¼ë‚˜â€¦ ë°°í¬ í›„ ì¹´ë‚˜ë¦¬ ìƒíƒœì—ì„œ íŠ¸ë˜í”½ì„ ì¡°ê¸ˆì”© ë„£ê¸° ì‹œì‘í•´ì„œ 20í¼ì„¼íŠ¸ê°€ ë˜ë©´ ì´ë‚´ ì„œí‚·ì´ ì—´ë¦¬ê³  ì¥ì• ê°€ ë‚¬ë‹¤. ì™œì§€â€¦ í•˜ê³  ë¶„ì„í•˜ë‹¤ê°€ ì•Œê²Œëœ ì‚¬ì‹¤ì— ëŒ€í•œ ì •ë¦¬</p>

<h3 id="ë©”íŠ¸ë¦­apm-ìƒ˜í”Œì„-ì—´ì‹¬íˆ-ë¶„ì„">ë©”íŠ¸ë¦­/apm ìƒ˜í”Œì„ ì—´ì‹¬íˆ ë¶„ì„</h3>
<ol>
  <li>íŠ¸ë˜í”½ ì—†ëŠ” ìƒíƒœì—ì„œ ê¸°ëŠ¥ì€ ì •ìƒìˆ˜í–‰ ëœë‹¤.</li>
  <li>Bì„œë²„ì˜ ë¦¬ìŠ¤í°ìŠ¤ê°€ ì—„ì²­ ëŠë ¤ì§€ëŠ” ìƒ˜í”Œì´ ê³„ì† ì°í˜”ë‹¤. requestMapping ë¶€ë¶„ì„ aspectë¡œ ê°ì‹¼ ë¶€ë¶„ì—ì„œ ì°ëŠ” ë¡œê·¸ì— ë‚˜ì˜¨ api ì˜ ì‹¤í–‰ì‹œê°„ì€ ë³€í™”ê°€ ì—†ì—ˆìœ¼ë‹ˆ í†°ìº£ í”„ë ˆì„ì›Œí¬ìª½ì—ì„œ íœë”©ì´ ê±¸ë ¸ìœ¼ë ¤ë‚˜?</li>
  <li>Bì„œë²„ì˜ CPUê°€ ì ì  íŠ€ë”ë‹ˆ 100ì„ ì°ì—ˆê³ , ê·¸ ë•Œë¶€í„° Aì„œë²„ì—ì„œ íƒ€ì„ì•„ì›ƒì´ ë‚˜ë©´ì„œ ì„œí‚·ì´ ì—´ë ¸ë‹¤.</li>
</ol>

<h3 id="ê°€ì„¤ê³¼-ê¸°ê°">ê°€ì„¤ê³¼ ê¸°ê°</h3>
<ol>
  <li>ë³‘ë ¬ì²˜ë¦¬ê°€ ë„ˆë¬´ ë¹ ë¥¸ ì†ë„ë¡œ ë˜ì–´ì„œ Bì„œë²„ê°€ ê²¬ë””ì§€ ëª»í–ˆë‹¤.
    <ul>
      <li>ë³‘ë ¬ì²˜ë¦¬ ë¹¼ê³  ìˆœì°¨ì²˜ë¦¬ í•´ë´ë„ í•´ì†Œ ì•ˆë¨</li>
    </ul>
  </li>
  <li>ì›¹í”ŒëŸ­ìŠ¤ ì „í™˜ í›„ ì–´ë”˜ê°€ ë¸”ë½ë˜ëŠ” ì½”ë“œê°€ ìˆì–´ì„œ, Bì„œë²„ì™€ ë¬´ê´€í•˜ê²Œ Aì„œë²„ì˜ ì˜ëª»ì´ë‹¤.
    <ul>
      <li>ë ˆë””ìŠ¤ ë°©ë¬¸(ReactiveRedisTemplate ì ìš©)ê³¼ api í˜¸ì¶œì´ ì „ë¶€ì—¬ì„œ ë¸”ë½ë  êµ¬ê°„ì´ ì—†ê³ , ìš°ì„  ì € Bì„œë²„ì˜ cpu íŠ€ëŠ” í˜„ìƒì´ ì„¤ëª…ì´ ì•ˆëœë‹¤.</li>
    </ul>
  </li>
  <li>httpClient ì»¤ë„¥ì…˜ í’€ ì„¤ì •ì´ ì˜ëª»ë¼ì„œ ì»¤ë„¥ì…˜ì´ ë§¤ë²ˆ ìƒˆë¡œ ì—°ê²°ë˜ëŠë¼ ê·¸ë¬ë‹¤.
    <ul>
      <li>http/1.1 ìŠ¤í™ì€ ë””í´íŠ¸ê°€ keep-alive ê³ , í˜¹ì‹œ ëª°ë¼ í—¤ë” ë„£ì–´ë„ í•´ê²° ì•ˆëë‹¤.</li>
      <li>Bì„œë²„ì˜ open files ê°€ íŠ€ì§€ ì•Šì•„ì„œ ìš°ì„ ì€ ì•„ë‹Œê±¸ë¡œâ€¦</li>
    </ul>
  </li>
</ol>

<h3 id="ë”¥ë‹¤ì´ë¸Œ">ë”¥ë‹¤ì´ë¸Œ</h3>
<p>í•˜ì—¬, ì´ìœ ë¥¼ ë„ë¬´ì§€ ì•Œ ìˆ˜ ì—†ì–´ ë¡œì»¬ì—ì„œ Aì„œë²„ë¥¼ êµ¬ë²„ì „ìœ¼ë¡œ ì™”ë‹¤ê°”ë‹¤ í•˜ë©° tcp ë¤í”„ë¥¼ ë– ë³¸ ê²°ê³¼â€¦ ë¬¸ì œê°€ ì›¹í”ŒëŸ­ìŠ¤ê°€ ì•„ë‹ˆë¼  <strong><em>http í´ë¼ì´ì–¸íŠ¸ë¥¼ restTemplate -&gt; webClient ë¡œ ë³€í™˜í•œ ë¶€ë¶„</em></strong>ì´ì—ˆìŒì„ ì•Œì•„ëƒˆë‹¤. Bì„œë²„ ìª½ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">Cookie: JSESSIONID=AE0B...</code> í•˜ëŠ” í—¤ë”ê°€ ë“¤ì–´ì˜¤ì§€ ì•Šì€ ê²ƒì´ë‹¤. ì—¥??</p>

<p><a href="https://datatracker.ietf.org/doc/html/rfc6265">RFC-6265</a> ì— ë”°ë¥´ë©´ ë§ˆë•…íˆ ì„œë²„ê°€ ë¦¬ìŠ¤í°ìŠ¤ì— <code class="language-plaintext highlighter-rouge">Set-Cookie</code> í—¤ë”ë¥¼ ë‚´ë ¤ì£¼ë©´ í´ë¼ì´ì–¸íŠ¸ëŠ” ë‹¤ìŒ ìš”ì²­ë¶€í„° ì¿ í‚¤ë¥¼ ë„£ì–´ì„œ ë³´ë‚´ì•¼ í•˜ëŠ”ë°, webClient ëŠ” ì´ ë™ì‘ì´ ì—†ì—ˆë˜ ê²ƒì´ë‹¤.</p>

<p><br /></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">Controller</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">webClient</span><span class="p">:</span> <span class="nc">WebClient</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">restTemplate</span><span class="p">:</span> <span class="nc">RestTemplate</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">enum</span> <span class="kd">class</span> <span class="nc">Type</span> <span class="p">{</span>
        <span class="nc">REST_TEMPLATE</span><span class="p">,</span>
        <span class="nc">WEB_CLIENT</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"test"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">test</span><span class="p">(</span>
        <span class="nd">@RequestParam</span><span class="p">(</span><span class="s">"type"</span><span class="p">)</span> <span class="n">type</span><span class="p">:</span> <span class="nc">Type</span>
    <span class="p">):</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">uri</span> <span class="p">=</span> <span class="s">"http://localhost:8080/get-cookie?type=$type"</span>
        <span class="kd">val</span> <span class="p">(</span><span class="py">user</span><span class="p">,</span> <span class="py">password</span><span class="p">)</span> <span class="p">=</span> <span class="nc">Auth</span><span class="p">.</span><span class="n">userPassword</span>

        <span class="k">return</span> <span class="k">when</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="nc">Type</span><span class="p">.</span><span class="nc">REST_TEMPLATE</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="n">restTemplate</span><span class="p">.</span><span class="nf">exchange</span><span class="p">(</span>
                    <span class="n">uri</span><span class="p">,</span>
                    <span class="nc">HttpMethod</span><span class="p">.</span><span class="nc">GET</span><span class="p">,</span>
                    <span class="nc">HttpEntity</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="nc">HttpHeaders</span><span class="p">().</span><span class="nf">also</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">setBasicAuth</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="p">}),</span>
                    <span class="kd">object</span> <span class="err">: </span><span class="nc">ParameterizedTypeReference</span><span class="p">&lt;</span><span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;&gt;()</span> <span class="p">{}</span>
                <span class="p">).</span><span class="n">body</span><span class="o">!!</span>
            <span class="p">}</span>
            <span class="nc">Type</span><span class="p">.</span><span class="nc">WEB_CLIENT</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="n">webClient</span><span class="p">.</span><span class="k">get</span><span class="p">()</span>
                    <span class="p">.</span><span class="nf">uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">headers</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">setBasicAuth</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="p">}</span>
                    <span class="p">.</span><span class="nf">retrieve</span><span class="p">()</span>
                    <span class="p">.</span><span class="nf">bodyToMono</span><span class="p">(</span><span class="kd">object</span> <span class="err">: </span><span class="nc">ParameterizedTypeReference</span><span class="p">&lt;</span><span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;&gt;()</span> <span class="p">{})</span>
                    <span class="p">.</span><span class="nf">block</span><span class="p">()</span><span class="o">!!</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"get-cookie"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getHeader</span><span class="p">(</span>
        <span class="n">httpServletRequest</span><span class="p">:</span> <span class="nc">HttpServletRequest</span><span class="p">,</span>
    <span class="p">):</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">mapOf</span><span class="p">(</span><span class="s">"Cookie"</span> <span class="nf">to</span> <span class="p">(</span><span class="n">httpServletRequest</span><span class="p">.</span><span class="n">cookies</span><span class="o">?.</span><span class="k">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span> <span class="s">"${it.name}=${it.value}"</span> <span class="p">}</span> <span class="o">?:</span> <span class="s">"null"</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">Security</span> <span class="p">:</span> <span class="nc">WebSecurityConfigurerAdapter</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">configure</span><span class="p">(</span><span class="n">http</span><span class="p">:</span> <span class="nc">HttpSecurity</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">http</span>
            <span class="p">.</span><span class="nf">httpBasic</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">and</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">authorizeRequests</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">antMatchers</span><span class="p">(</span><span class="s">"/get-cookie"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">hasRole</span><span class="p">(</span><span class="nc">Auth</span><span class="p">.</span><span class="n">role</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">configure</span><span class="p">(</span><span class="n">auth</span><span class="p">:</span> <span class="nc">AuthenticationManagerBuilder</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">encoder</span> <span class="p">=</span> <span class="nc">PasswordEncoderFactories</span><span class="p">.</span><span class="nf">createDelegatingPasswordEncoder</span><span class="p">()</span>
        <span class="kd">val</span> <span class="p">(</span><span class="py">user</span><span class="p">,</span> <span class="py">password</span><span class="p">)</span> <span class="p">=</span> <span class="nc">Auth</span><span class="p">.</span><span class="n">userPassword</span>
        <span class="n">auth</span><span class="p">.</span><span class="nf">inMemoryAuthentication</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">withUser</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="nf">password</span><span class="p">(</span><span class="n">encoder</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">password</span><span class="p">)).</span><span class="nf">roles</span><span class="p">(</span><span class="nc">Auth</span><span class="p">.</span><span class="n">role</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì´ ì½”ë“œëŠ” <code class="language-plaintext highlighter-rouge">spring-boot-starter-security</code> ë¥¼ ì‚¬ìš©í–ˆë‹¤. <code class="language-plaintext highlighter-rouge">/get-cookie</code> api ëŠ” basicAuth ê°€ ì ìš©ë˜ì–´ ìˆê³  ë¦¬í€˜ìŠ¤íŠ¸ì˜ <code class="language-plaintext highlighter-rouge">Cookie</code> í—¤ë”ë¥¼ ë¦¬í„´í•œë‹¤. <code class="language-plaintext highlighter-rouge">/test</code> api ëŠ” í˜¸ì¶œì‹œ íŒŒë¼ë¯¸í„°ì— ë”°ë¼ ê°ê° restTemplate/webClient ë¥¼ ì´ìš©í•´ì„œ <code class="language-plaintext highlighter-rouge">/get-cookie</code> ë¥¼ í˜¸ì¶œí•˜ë©°, ê·¸ í˜¸ì¶œì˜ ì‘ë‹µì„ ê·¸ëŒ€ë¡œ ë¦¬í„´í•œë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>whojes@whojes01-2:~/workspace/test/web-client-test<span class="nv">$ </span>curl <span class="s2">"localhost:8080/test?type=REST_TEMPLATE"</span>
<span class="o">{</span><span class="s2">"Cookie"</span>:<span class="s2">"null"</span><span class="o">}</span>
whojes@whojes01-2:~/workspace/test/web-client-test<span class="nv">$ </span>curl <span class="s2">"localhost:8080/test?type=REST_TEMPLATE"</span>
<span class="o">{</span><span class="s2">"Cookie"</span>:<span class="s2">"JSESSIONID=407F0D466773B4F5DA32BD0B863BF0EB"</span><span class="o">}</span>
whojes@whojes01-2:~/workspace/test/web-client-test<span class="err">$</span>
whojes@whojes01-2:~/workspace/test/web-client-test<span class="nv">$ </span>curl <span class="s2">"localhost:8080/test?type=WEB_CLIENT"</span>
<span class="o">{</span><span class="s2">"Cookie"</span>:<span class="s2">"null"</span><span class="o">}</span>
whojes@whojes01-2:~/workspace/test/web-client-test<span class="nv">$ </span>curl <span class="s2">"localhost:8080/test?type=WEB_CLIENT"</span>
<span class="o">{</span><span class="s2">"Cookie"</span>:<span class="s2">"null"</span><span class="o">}</span>
whojes@whojes01-2:~/workspace/test/web-client-test<span class="nv">$ </span>curl <span class="s2">"localhost:8080/test?type=REST_TEMPLATE"</span>
<span class="o">{</span><span class="s2">"Cookie"</span>:<span class="s2">"JSESSIONID=407F0D466773B4F5DA32BD0B863BF0EB"</span><span class="o">}</span>
whojes@whojes01-2:~/workspace/test/web-client-test<span class="nv">$ </span>
</code></pre></div></div>
:ET