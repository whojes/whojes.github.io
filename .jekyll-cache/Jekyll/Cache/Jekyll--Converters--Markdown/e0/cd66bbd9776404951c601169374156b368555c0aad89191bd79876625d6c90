I"ø<p>ë¦¬ëˆ…ìŠ¤ í™˜ê²½ì—ì„œ Jvm ì€ <code class="language-plaintext highlighter-rouge">SIGTERM</code> ì´ ë“¤ì–´ì˜¬ ê²½ìš° graceful shutdown ì„ ì§„í–‰í•œë‹¤. ì—¬ê¸°ì— í•„ìš”í•œ ì½”ë“œëŠ”</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Runtime</span><span class="p">.</span><span class="nf">getRuntime</span><span class="p">().</span><span class="nf">addShutdownHook</span><span class="p">(</span><span class="nc">Thread</span> <span class="p">{</span> <span class="n">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s">"whojes"</span><span class="p">)</span> <span class="p">})</span>
</code></pre></div></div>

<hr />

<p>spring boot ì•±ì—ì„œ ì–´ë–¤ í›…ì´ ë“±ë¡ë˜ì—ˆëŠ”ì§€ ë¦¬í”Œë ‰ì…˜ì„ ì¨ì„œ í™•ì¸í•´ë³´ë©´</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">clazz</span> <span class="p">=</span> <span class="nc">Class</span><span class="p">.</span><span class="nf">forName</span><span class="p">(</span><span class="s">"java.lang.ApplicationShutdownHooks"</span><span class="p">)</span>
<span class="kd">val</span> <span class="py">field</span> <span class="p">=</span> <span class="n">clazz</span><span class="p">.</span><span class="nf">getDeclaredField</span><span class="p">(</span><span class="s">"hooks"</span><span class="p">)</span>
<span class="n">field</span><span class="p">.</span><span class="n">isAccessible</span> <span class="p">=</span> <span class="k">true</span>
<span class="kd">val</span> <span class="py">threads</span> <span class="p">=</span> <span class="n">field</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">clazz</span><span class="p">)</span> <span class="k">as</span> <span class="nc">IdentityHashMap</span><span class="p">&lt;</span><span class="nc">Thread</span><span class="p">,</span> <span class="nc">Thread</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>ì—¬ê¸°ì„œ threads ë¥¼ ì‚´í´ë³´ë©´</p>
<blockquote>
  <ol>
    <li><code class="language-plaintext highlighter-rouge">{LogManager$Cleaner@~} "Thread[Thread-0,5,main]"</code></li>
    <li><code class="language-plaintext highlighter-rouge">{AbstracApplicationContext$1@~} "Thread[SpringContextShutdownHook,5,main]"</code></li>
  </ol>
</blockquote>

<p>ì´ë ‡ê²Œ ë‘ ê°œì˜ shutdown í›…ì´ ë“±ë¡ë˜ì–´ ìˆë‹¤.</p>

<p>ì²«ë²ˆì§¸ í›…ì€ <code class="language-plaintext highlighter-rouge">java.util.logging.LogManager$Cleaner</code>ì“°ë ˆë“œë¡œ, ìë°” 1.4ì—ì„œ ë„ì…ëœ.. ë­.. ê·¸ëŸ°ê±°ê³ , ë‘ë²ˆì§¸ ê²ƒì´ spring boot ì—ì„œ ë“±ë¡í•œ í›…ì´ë‹¤. spring boot í”„ë ˆì„ì›Œí¬ì—ì„œ ê°œë°œì„ í•  ë•Œì— ìœ ì €ë ˆë²¨ì—ì„œ ì„œë²„ê°€ ì¢…ë£Œë  ë•Œ ë™ì‘í–ˆìœ¼ë©´ í•˜ëŠ” ì½”ë“œê°€ ìˆìœ¼ë©´ <code class="language-plaintext highlighter-rouge">ContextClosedEvent</code> ì´ë²¤íŠ¸ë¥¼ ë¦¬ìŠ¤ë‹í•´ì„œ í›…ì„ ë“±ë¡í•˜ëŠ”ê²Œ ë‚«ë‹¤. <code class="language-plaintext highlighter-rouge">Runtime.getRuntime()</code> ì— ë“±ë¡ëœ í›…ë“¤ì´ ì‹¤í–‰ë  ë•ŒëŠ” ìˆœì„œê°€ ì—†ê¸° ë•Œë¬¸ì—, spring boot context ì— ë“±ë¡í•˜ì§€ ì•Šê³  ë”°ë¡œ <code class="language-plaintext highlighter-rouge">Runtime</code> ì— ë“±ë¡ì„ í•´ë‘ê²Œ ë˜ë©´ spring boot context ì˜ ì¢…ë£Œê°€ ë˜ê¸° ì „ì— ì‚¬ìš©í•˜ëŠ” ëª¨ë“ˆì´ ë‚´ë ¤ê°€ë²„ë¦¬ëŠ” ë¶ˆìƒì‚¬ê°€ ë°œìƒí•  ìˆ˜ë„ ìˆê¸° ë•Œë¬¸ì´ë‹¤.</p>

<hr />

<p>(<strong>apache shardingsphere</strong>)[https://shardingsphere.apache.org/]{:target=â€_blankâ€} ëŠ” ì•„íŒŒì¹˜ì—ì„œ ì œê³µí•˜ëŠ” ìƒ¤ë”© ë¼ì´ë¸ŒëŸ¬ë¦¬ì¸ë°, ì—¬ê¸°ì„œëŠ” broadcasting table ì— ëŒ€í•´ ê°ê°ì˜ ìƒ¤ë“œë¡œ ì¿¼ë¦¬ë¥¼ ë‚ ë¦´ ë•Œ ìì²´ì ìœ¼ë¡œ ì“°ë ˆë“œí’€ì„ ë§Œë“¤ì–´ì„œ ì¿¼ë¦¬ë¥¼ ë‚ ë¦°ë‹¤. ì…§ë‹¤ìš´ í›…ì´ ì™”ì„ ë•Œ ê·¸ ìŠ¤ë ˆë“œí’€ì´ ë‚´ë ¤ê°€ëŠ”ë°, ìš” ë™ì‘ì´ <code class="language-plaintext highlighter-rouge">java.lang.Runtime</code> ì— ì§ì ‘ ë“±ë¡ì´ ë˜ì–´ìˆë‹¤. <a href="https://github.com/apache/shardingsphere/blob/master/shardingsphere-infra/shardingsphere-infra-executor/src/main/java/org/apache/shardingsphere/infra/executor/kernel/thread/ExecutorServiceManager.java#L47" target=":blank">https://github.com/apache/shardingsphere/blob/master/shardingsphere-infra/shardingsphere-infra-executor/src/main/java/org/apache/shardingsphere/infra/executor/kernel/thread/ExecutorServiceManager.java#L47</a></p>

<p>ê·¸ë ‡ê¸° ë•Œë¬¸ì—, ë‚´ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì—ì„œ ë””íœë˜ì‹œê°€ ìˆëŠ” <code class="language-plaintext highlighter-rouge">JpaRepository</code> ê°€ ë¨¼ì € ë‚´ë ¤ê°€ê¸° ì „ì— ê·¸ ì“°ë ˆë“œí’€ì´ ë¨¼ì € ë‚´ë ¤ê°€ ë²„ë¦¬ëŠ” ìƒí™©ì´ ì¢…ì¢… ë°œìƒí–ˆê³ , ê·¸ë¡œ ì¸í•´ ì—ëŸ¬ê°€ ì˜¬ë¼ì˜¤ê³  ìˆì—ˆë‹¤. ì € ì½”ë“œì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">google guava</code> ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ (<code class="language-plaintext highlighter-rouge">MoreExecutors.addDelayedShutdownHook</code>)[https://guava.dev/releases/22.0/api/docs/com/google/common/util/concurrent/MoreExecutors.html#addDelayedShutdownHook-java.util.concurrent.ExecutorService-long-java.util.concurrent.TimeUnit-]{:target=â€_blankâ€} ë¥¼ ì‚¬ìš©í•˜ëŠ”ë°, ì´ë¦„ì€ delayed shutdown ì´ì§€ë§Œ ì½”ë“œë¥¼ ì½ì–´ë³´ë©´ ì‹œê°„ì„ ê¸°ë‹¤ë¦¬ê³  shutdown ì„ ë‚ ë¦¬ëŠ”ê²Œ ì•„ë‹ˆë¼ ìš°ì„  shutdown ì„ í•˜ê³  ì‹œê°„ë™ì•ˆ ê¸°ë‹¤ë¦¬ëŠ” ì½”ë“œê°€ ë˜ì—ˆë‹¤.</p>
:ET