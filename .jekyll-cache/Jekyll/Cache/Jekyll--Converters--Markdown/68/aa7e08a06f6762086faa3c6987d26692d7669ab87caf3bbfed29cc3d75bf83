I"É<p>k8s ì—ì„œ ì„œë¹™ì¤‘ì¸ pod ì— ê°ê° ì‚¬ì´ë“œì¹´ì¸ envoy ê°€ ë¶™ì–´ìˆë‹¤. L7 filter ìš©ë„ë¡œ ì“°ê³ ìˆì–´ì„œ, ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆë¡œ íŒ¨í‚·ì´ ì „ë‹¬ë˜ê¸° ì „ì— ì‚¬ì´ë“œì¹´ì— ë¨¼ì € ë“¤ë €ë‹¤ê°€ ë‚˜ê°€ëŠ”ë°â€¦</p>

<hr />

<p>kublet ì´ pod ì— shutdown hook ì„ ë‚ ë¦¬ê²Œ ë˜ë©´, envoy ì»¨í…Œì´ë„ˆì™€ ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆê°€ ê°™ì´ ì…§ë‹¤ìš´ í›…ì„ ë°›ëŠ”ë‹¤. ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆ(ì—¬ê¸°ì„œëŠ” í†°ìº£)ëŠ” ì…§ë‹¤ìš´ í›…ì„ ë°›ê³  í•˜ë˜ ì¼ì„ ì°¨ë¡€ë¡œ ì •ë¦¬í•˜ê¸° ì‹œì‘í•œë‹¤. envoy ì»¨í…Œì´ë„ˆëŠ” ìì‹ ì´ ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆê°€ ë‚´ë ¤ê°€ê¸° ì „ì— ë¨¼ì € ë‚´ë ¤ê°€ê²Œ ë˜ë©´ ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆë¡œ íŒ¨í‚·ì´ ê°€ëŠ” ê¸¸ì´ ë§‰íˆê¸° ë•Œë¬¸ì— ì„œë¹„ìŠ¤ê°€ ì˜ë„í•˜ì§€ ì•Šì€ ìƒíƒœì—ì„œ <code class="language-plaintext highlighter-rouge">500 service unavailable</code> ìƒíƒœê°€ ë  ìˆ˜ê°€ ìˆê¸° ë•Œë¬¸ì—, ì„œë¹„ìŠ¤ ì»¨í…Œì´ë„ˆì˜ í—¬ìŠ¤ë¥¼ ì²´í¬í•´ì„œ unhealthy ìƒíƒœê°€ ë˜ë©´ ì„œë¹„ìŠ¤ë¥¼ ë‚´ë¦°ë‹¤. <a href="https://istio.io/latest/docs/ops/configuration/mesh/app-health-check/" target="_blank">ì°¸ì¡°</a></p>

<p>api ì„œë¹™ê³¼ kafka consuming ì„ ë™ì‹œì— í•˜ëŠ” ì„œë²„ê°€ ìˆë‹¤. ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ê³  ìˆë˜ ì„œë²„ë¥¼ ë‚´ë¦°ë‹¤ê³  í–ˆì„ ë•Œ</p>
<ol>
  <li>api íŠ¸ë˜í”½ì„ ëº€ë‹¤. (ingressì•¼ í˜ì„ ë‚´)</li>
  <li>ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ graceful shutdown ì„ í•œë‹¤. (shutdown hook)
    <ul>
      <li>api íŠ¸ë˜í”½ì€ ì•ì—ì„œ ë¹¼ì¤¬ìœ¼ë‹ˆ, ì»¨ìŠˆë¨¸ ë¹ˆê³¼ ë””íœë˜ì‹œ ê±¸ë ¤ìˆëŠ” ì• ë“¤ì„ ì •ë¦¬í•œë‹¤.</li>
      <li>ì»¨ìŠˆë¨¸ ë¹ˆì„ í¬í•¨í•œ bean ë“¤ì´ destroy ê°€ ëë‚˜ë©´ health check path ì˜ status ë¥¼ unhealthy ë¡œ ë³€ê²½í•œë‹¤.</li>
    </ul>
  </li>
  <li>ë! ë³„ ë¬¸ì œ ì—†ì´ ê¹”ë”í•˜ë‹¤.</li>
</ol>

<p>ê·¸ëŸ¬ë‚˜ ì•„ì§ ë¶€íŒ…ì´ ëë‚˜ì§€ ì•Šì€ ìƒíƒœì˜ pod ì— ì…§ë‹¤ìš´ í›…ì´ ë“¤ì–´ì˜¤ê²Œ ë˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ ì´ìƒë™ì‘ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤.</p>
<ol>
  <li>bean initialize - kafka consumer bean initialized, auto startup (<code class="language-plaintext highlighter-rouge">AbstractMessageListenerContainer</code> ì˜ default ë™ì‘) ë˜ì–´ì„œ ì¼í•˜ê¸° ì‹œì‘í•¨</li>
  <li>shutdown hook ë“¤ì–´ì˜´</li>
  <li>ì „ì²´ bean initialize ê°€ ì•„ì§ ì™„ë£ŒëŠ” ë˜ì§€ ì•Šì•„ì„œ (í˜¹ì€ ì™„ë£Œ ë˜ì–´ë„ health on í•˜ê¸° ì „ì´ë¼ì„œ) health ëŠ” ë“¤ì–´ì˜¤ì§€ ì•ŠìŒ</li>
  <li>envoy ê°€ service unavailable ìœ¼ë¡œ íŒë‹¨, outbound traffic ì„ ë‚´ë¦¼</li>
  <li>ì¹´í”„ì¹´ ì»¨ìŠˆë¨¸ì—ì„œ ì™¸ë¶€ë¡œ api í˜¸ì¶œì„ í•˜ëŠ” ë¶€ë¶„ì´ ìˆë‹¤ë©´, ë°”ë¡œ ë§‰í˜€ë²„ë¦¼</li>
</ol>

<p>ê·¸ë˜ì„œ, ê²°êµ­ kafka consumer bean ì˜ ë¼ì´í”„ì‚¬ì´í´ì„ container ì˜ health ë¼ì´í”„ì‚¬ì´í´ê³¼ ë§ì¶°ì¤„ í•„ìš”ê°€ ìˆë‹¤.</p>

<p>auto-startup ì˜µì…˜ì„ êº¼ì£¼ê³ , <code class="language-plaintext highlighter-rouge">org.springframework.boot.context.event.ApplicationReadyEvent</code> ë¥¼ ë°›ì•„ì„œ ê·¸ë•Œ startup ì„ í•´ì£¼ë©´ ë¬¸ì œ ë~</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="k">fun</span> <span class="nf">kafkaListener</span><span class="p">():</span> <span class="nc">KafkaListenerContainerFactory</span><span class="p">&lt;</span><span class="nc">ConcurrentMessageListenerContainer</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nc">ConcurrentKafkaListenerContainerFactory</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;().</span><span class="nf">apply</span> <span class="p">{</span>
        <span class="nf">setAutoStartup</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
        <span class="o">..</span><span class="p">.</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@Bean</span>
<span class="k">fun</span> <span class="nf">startupHandler</span><span class="p">(</span><span class="n">listeners</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">MessageListenerContainer</span><span class="p">&gt;):</span> <span class="nc">ApplicationListener</span><span class="p">&lt;</span><span class="nc">ApplicationReadyEvent</span><span class="p">&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nc">ApplicationListener</span> <span class="p">{</span> <span class="n">listeners</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>spring boot ë²„ì „ì— ë”°ë¼ <code class="language-plaintext highlighter-rouge">KafkaListenerEndpointRegistry</code> ë¹ˆìœ¼ë¡œë¶€í„° í•´ë‹¹ ì‘ì—… (<code class="language-plaintext highlighter-rouge">messageListenerContainer.start()</code>)
ì„ ì§„í–‰í•´ ì¤˜ì•¼ í•  ìˆ˜ë„ ìˆë‹¤.</p>
:ET