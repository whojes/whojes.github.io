I"€[<p>ì‚¬ê±´ì˜ ë°œë‹¨ì€ webflux ë¡œì˜ ì „í™˜ì´ì—ˆë‹¤. Aì„œë²„ -&gt; Bì„œë²„ ì˜ api íë¦„ì„ ê°€ì§€ëŠ” ì‹œìŠ¤í…œì—ì„œ Aì„œë²„ë¥¼ ì›¹í”ŒëŸ­ìŠ¤ë¡œ ì „í™˜í•˜ì—¬ cpu usage ë° Bì„œë²„ í˜¸ì¶œ ë³‘ë ¬ì²˜ë¦¬ë¡œ response time ì„ ì ˆì•½í•˜ë ¤ëŠ” ì·¨ì§€ì˜€ìœ¼ë‚˜â€¦ ë°°í¬ í›„ ì¹´ë‚˜ë¦¬ ìƒíƒœì—ì„œ íŠ¸ë˜í”½ì„ ì¡°ê¸ˆì”© ë„£ê¸° ì‹œì‘í•´ì„œ 20í¼ì„¼íŠ¸ê°€ ë˜ë©´ ì´ë‚´ ì„œí‚·ì´ ì—´ë¦¬ê³  ì¥ì• ê°€ ë‚¬ë‹¤. ì™œì§€â€¦ í•˜ê³  ë¶„ì„í•˜ë‹¤ê°€ ì•Œê²Œëœ ì‚¬ì‹¤ì— ëŒ€í•œ ì •ë¦¬</p>

<h3 id="ë©”íŠ¸ë¦­apm-ìƒ˜í”Œì„-ì—´ì‹¬íˆ-ë¶„ì„">ë©”íŠ¸ë¦­/apm ìƒ˜í”Œì„ ì—´ì‹¬íˆ ë¶„ì„</h3>
<ol>
  <li>íŠ¸ë˜í”½ ì—†ëŠ” ìƒíƒœì—ì„œ ê¸°ëŠ¥ì€ ì •ìƒìˆ˜í–‰ ëœë‹¤.</li>
  <li>Bì„œë²„ì˜ ë¦¬ìŠ¤í°ìŠ¤ê°€ ì—„ì²­ ëŠë ¤ì§€ëŠ” ìƒ˜í”Œì´ ê³„ì† ì°í˜”ë‹¤. requestMapping ë¶€ë¶„ì„ aspectë¡œ ê°ì‹¼ ë¶€ë¶„ì—ì„œ ì°ëŠ” ë¡œê·¸ì— ë‚˜ì˜¨ api ì˜ ì‹¤í–‰ì‹œê°„ì€ ë³€í™”ê°€ ì—†ì—ˆìœ¼ë‹ˆ í†°ìº£ í”„ë ˆì„ì›Œí¬ìª½ì—ì„œ íœë”©ì´ ê±¸ë ¸ìœ¼ë ¤ë‚˜?</li>
  <li>Bì„œë²„ì˜ CPUê°€ ì ì  íŠ€ë”ë‹ˆ 100ì„ ì°ì—ˆê³ , ê·¸ ë•Œë¶€í„° Aì„œë²„ì—ì„œ íƒ€ì„ì•„ì›ƒì´ ë‚˜ë©´ì„œ ì„œí‚·ì´ ì—´ë ¸ë‹¤.</li>
</ol>

<h3 id="ê°€ì„¤ê³¼-ê¸°ê°">ê°€ì„¤ê³¼ ê¸°ê°</h3>
<ol>
  <li>ë³‘ë ¬ì²˜ë¦¬ê°€ ë„ˆë¬´ ë¹ ë¥¸ ì†ë„ë¡œ ë˜ì–´ì„œ Bì„œë²„ê°€ ê²¬ë””ì§€ ëª»í–ˆë‹¤.
    <ul>
      <li>ë³‘ë ¬ì²˜ë¦¬ ë¹¼ê³  ìˆœì°¨ì²˜ë¦¬ í•´ë´ë„ í•´ì†Œ ì•ˆë¨</li>
    </ul>
  </li>
  <li>ì›¹í”ŒëŸ­ìŠ¤ ì „í™˜ í›„ ì–´ë”˜ê°€ ë¸”ë½ë˜ëŠ” ì½”ë“œê°€ ìˆì–´ì„œ, Bì„œë²„ì™€ ë¬´ê´€í•˜ê²Œ Aì„œë²„ì˜ ì˜ëª»ì´ë‹¤.
    <ul>
      <li>ë ˆë””ìŠ¤ ë°©ë¬¸(ReactiveRedisTemplate ì ìš©)ê³¼ api í˜¸ì¶œì´ ì „ë¶€ì—¬ì„œ ë¸”ë½ë  êµ¬ê°„ì´ ì—†ê³ , ìš°ì„  ì € Bì„œë²„ì˜ cpu íŠ€ëŠ” í˜„ìƒì´ ì„¤ëª…ì´ ì•ˆëœë‹¤.</li>
    </ul>
  </li>
  <li>httpClient ì»¤ë„¥ì…˜ í’€ ì„¤ì •ì´ ì˜ëª»ë¼ì„œ ì»¤ë„¥ì…˜ì´ ë§¤ë²ˆ ìƒˆë¡œ ì—°ê²°ë˜ëŠë¼ ê·¸ë¬ë‹¤.
    <ul>
      <li>http/1.1 ìŠ¤í™ì€ ë””í´íŠ¸ê°€ keep-alive ê³ , í˜¹ì‹œ ëª°ë¼ í—¤ë” ë„£ì–´ë„ í•´ê²° ì•ˆëë‹¤.</li>
      <li>Bì„œë²„ì˜ open files ê°€ íŠ€ì§€ ì•Šì•„ì„œ ìš°ì„ ì€ ì•„ë‹Œê±¸ë¡œâ€¦</li>
    </ul>
  </li>
</ol>

<h3 id="ë”¥ë‹¤ì´ë¸Œ">ë”¥ë‹¤ì´ë¸Œ</h3>
<p>í•˜ì—¬, ì´ìœ ë¥¼ ë„ë¬´ì§€ ì•Œ ìˆ˜ ì—†ì–´ ë¡œì»¬ì—ì„œ Aì„œë²„ë¥¼ êµ¬ë²„ì „ìœ¼ë¡œ ì™”ë‹¤ê°”ë‹¤ í•˜ë©° tcp ë¤í”„ë¥¼ ë– ë³¸ ê²°ê³¼â€¦ ë¬¸ì œê°€ ì›¹í”ŒëŸ­ìŠ¤ê°€ ì•„ë‹ˆë¼  <strong><em>http í´ë¼ì´ì–¸íŠ¸ë¥¼ restTemplate -&gt; webClient ë¡œ ë³€í™˜í•œ ë¶€ë¶„</em></strong>ì´ì—ˆìŒì„ ì•Œì•„ëƒˆë‹¤. Bì„œë²„ ìª½ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">Cookie: JSESSIONID=AE0B...</code> í•˜ëŠ” í—¤ë”ê°€ ë“¤ì–´ì˜¤ì§€ ì•Šì€ ê²ƒì´ë‹¤. ì—¥??</p>

<p><a href="https://datatracker.ietf.org/doc/html/rfc6265">RFC-6265</a> ì— ë”°ë¥´ë©´ ë§ˆë•…íˆ ì„œë²„ê°€ ë¦¬ìŠ¤í°ìŠ¤ì— <code class="language-plaintext highlighter-rouge">Set-Cookie</code> í—¤ë”ë¥¼ ë‚´ë ¤ì£¼ë©´ í´ë¼ì´ì–¸íŠ¸ëŠ” ë‹¤ìŒ ìš”ì²­ë¶€í„° ì¿ í‚¤ë¥¼ ë„£ì–´ì„œ ë³´ë‚´ì•¼ í•˜ëŠ”ë°, webClient ëŠ” ì´ ë™ì‘ì´ ì—†ì—ˆë˜ ê²ƒì´ë‹¤.</p>

<p><br /></p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">"/"</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">Controller</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">webClient</span><span class="p">:</span> <span class="nc">WebClient</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">restTemplate</span><span class="p">:</span> <span class="nc">RestTemplate</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">enum</span> <span class="kd">class</span> <span class="nc">Type</span> <span class="p">{</span>
        <span class="nc">REST_TEMPLATE</span><span class="p">,</span>
        <span class="nc">WEB_CLIENT</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"test"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">test</span><span class="p">(</span>
        <span class="nd">@RequestParam</span><span class="p">(</span><span class="s">"type"</span><span class="p">)</span> <span class="n">type</span><span class="p">:</span> <span class="nc">Type</span>
    <span class="p">):</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">uri</span> <span class="p">=</span> <span class="s">"http://localhost:8080/get-cookie?type=$type"</span>
        <span class="kd">val</span> <span class="p">(</span><span class="py">user</span><span class="p">,</span> <span class="py">password</span><span class="p">)</span> <span class="p">=</span> <span class="nc">Auth</span><span class="p">.</span><span class="n">userPassword</span>

        <span class="k">return</span> <span class="k">when</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
            <span class="nc">Type</span><span class="p">.</span><span class="nc">REST_TEMPLATE</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="n">restTemplate</span><span class="p">.</span><span class="nf">exchange</span><span class="p">(</span>
                    <span class="n">uri</span><span class="p">,</span>
                    <span class="nc">HttpMethod</span><span class="p">.</span><span class="nc">GET</span><span class="p">,</span>
                    <span class="nc">HttpEntity</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="nc">HttpHeaders</span><span class="p">().</span><span class="nf">also</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">setBasicAuth</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="p">}),</span>
                    <span class="kd">object</span> <span class="err">: </span><span class="nc">ParameterizedTypeReference</span><span class="p">&lt;</span><span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;&gt;()</span> <span class="p">{}</span>
                <span class="p">).</span><span class="n">body</span><span class="o">!!</span>
            <span class="p">}</span>
            <span class="nc">Type</span><span class="p">.</span><span class="nc">WEB_CLIENT</span> <span class="p">-&gt;</span> <span class="p">{</span>
                <span class="n">webClient</span><span class="p">.</span><span class="k">get</span><span class="p">()</span>
                    <span class="p">.</span><span class="nf">uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
                    <span class="p">.</span><span class="nf">headers</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">setBasicAuth</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> <span class="p">}</span>
                    <span class="p">.</span><span class="nf">retrieve</span><span class="p">()</span>
                    <span class="p">.</span><span class="nf">bodyToMono</span><span class="p">(</span><span class="kd">object</span> <span class="err">: </span><span class="nc">ParameterizedTypeReference</span><span class="p">&lt;</span><span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;&gt;()</span> <span class="p">{})</span>
                    <span class="p">.</span><span class="nf">block</span><span class="p">()</span><span class="o">!!</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@GetMapping</span><span class="p">(</span><span class="s">"get-cookie"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getHeader</span><span class="p">(</span>
        <span class="n">httpServletRequest</span><span class="p">:</span> <span class="nc">HttpServletRequest</span><span class="p">,</span>
    <span class="p">):</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">mapOf</span><span class="p">(</span><span class="s">"Cookie"</span> <span class="nf">to</span> <span class="p">(</span><span class="n">httpServletRequest</span><span class="p">.</span><span class="n">cookies</span><span class="o">?.</span><span class="k">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span> <span class="s">"${it.name}=${it.value}"</span> <span class="p">}</span> <span class="o">?:</span> <span class="s">"null"</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">Security</span> <span class="p">:</span> <span class="nc">WebSecurityConfigurerAdapter</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">configure</span><span class="p">(</span><span class="n">http</span><span class="p">:</span> <span class="nc">HttpSecurity</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">http</span>
            <span class="p">.</span><span class="nf">httpBasic</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">and</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">authorizeRequests</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">antMatchers</span><span class="p">(</span><span class="s">"/get-cookie"</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">hasRole</span><span class="p">(</span><span class="nc">Auth</span><span class="p">.</span><span class="n">role</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">configure</span><span class="p">(</span><span class="n">auth</span><span class="p">:</span> <span class="nc">AuthenticationManagerBuilder</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">encoder</span> <span class="p">=</span> <span class="nc">PasswordEncoderFactories</span><span class="p">.</span><span class="nf">createDelegatingPasswordEncoder</span><span class="p">()</span>
        <span class="kd">val</span> <span class="p">(</span><span class="py">user</span><span class="p">,</span> <span class="py">password</span><span class="p">)</span> <span class="p">=</span> <span class="nc">Auth</span><span class="p">.</span><span class="n">userPassword</span>
        <span class="n">auth</span><span class="p">.</span><span class="nf">inMemoryAuthentication</span><span class="p">()</span>
            <span class="p">.</span><span class="nf">withUser</span><span class="p">(</span><span class="n">user</span><span class="p">).</span><span class="nf">password</span><span class="p">(</span><span class="n">encoder</span><span class="p">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">password</span><span class="p">)).</span><span class="nf">roles</span><span class="p">(</span><span class="nc">Auth</span><span class="p">.</span><span class="n">role</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì´ ì½”ë“œëŠ” <code class="language-plaintext highlighter-rouge">spring-boot-starter-security</code> ë¥¼ ì‚¬ìš©í–ˆë‹¤. <code class="language-plaintext highlighter-rouge">/get-cookie</code> api ëŠ” basicAuth ê°€ ì ìš©ë˜ì–´ ìˆê³  ë¦¬í€˜ìŠ¤íŠ¸ì˜ <code class="language-plaintext highlighter-rouge">Cookie</code> í—¤ë”ë¥¼ ë¦¬í„´í•œë‹¤. <code class="language-plaintext highlighter-rouge">/test</code> api ëŠ” í˜¸ì¶œì‹œ íŒŒë¼ë¯¸í„°ì— ë”°ë¼ ê°ê° restTemplate/webClient ë¥¼ ì´ìš©í•´ì„œ <code class="language-plaintext highlighter-rouge">/get-cookie</code> ë¥¼ í˜¸ì¶œí•˜ë©°, ê·¸ í˜¸ì¶œì˜ ì‘ë‹µì„ ê·¸ëŒ€ë¡œ ë¦¬í„´í•œë‹¤.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@whojes:~/<span class="nv">$ </span>curl <span class="s2">"localhost:8080/test?type=REST_TEMPLATE"</span>
<span class="o">{</span><span class="s2">"Cookie"</span>:<span class="s2">"null"</span><span class="o">}</span>
root@whojes:~/<span class="nv">$ </span>curl <span class="s2">"localhost:8080/test?type=REST_TEMPLATE"</span>
<span class="o">{</span><span class="s2">"Cookie"</span>:<span class="s2">"JSESSIONID=407F0D466773B4F5DA32BD0B863BF0EB"</span><span class="o">}</span>
root@whojes:~/<span class="err">$</span>
root@whojes:~/<span class="nv">$ </span>curl <span class="s2">"localhost:8080/test?type=WEB_CLIENT"</span>
<span class="o">{</span><span class="s2">"Cookie"</span>:<span class="s2">"null"</span><span class="o">}</span>
root@whojes:~/<span class="nv">$ </span>curl <span class="s2">"localhost:8080/test?type=WEB_CLIENT"</span>
<span class="o">{</span><span class="s2">"Cookie"</span>:<span class="s2">"null"</span><span class="o">}</span>
root@whojes:~/<span class="nv">$ </span>curl <span class="s2">"localhost:8080/test?type=REST_TEMPLATE"</span>
<span class="o">{</span><span class="s2">"Cookie"</span>:<span class="s2">"JSESSIONID=407F0D466773B4F5DA32BD0B863BF0EB"</span><span class="o">}</span>
root@whojes:~/<span class="nv">$ </span>
</code></pre></div></div>

<p>restTemplate ì„ ì´ìš©í•˜ë©´ ë‘ë²ˆì§¸ í˜¸ì¶œë¶€í„°ëŠ” <code class="language-plaintext highlighter-rouge">Set-Cookie</code> ë¡œ ì „ë‹¬ë°›ì€ ì¿ í‚¤ë¥¼ ë„£ì–´ì„œ ë³´ë‚´ì£¼ì§€ë§Œ, webClient ë¥¼ ì´ìš©í•˜ë©´ í•´ë‹¹ ê³¼ì •ì´ ì—†ë‹¤.</p>

<hr />

<p>ë¬¼ë¡  ì´ê±´ <code class="language-plaintext highlighter-rouge">restTemplate</code> ì„ ìƒì„±í•  ë•Œ requestFactory ë¥¼ ì„¸íŒ…í•´ì¤˜ì•¼ í•œë‹¤.</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="kd">val</span> <span class="py">restTemplate</span> <span class="p">=</span> <span class="nc">RestTemplate</span><span class="p">().</span><span class="nf">apply</span> <span class="p">{</span>
    <span class="n">requestFactory</span> <span class="p">=</span> <span class="nc">HttpComponentsClientHttpRequestFactory</span><span class="p">(</span><span class="nc">HttpClientBuilder</span><span class="p">.</span><span class="nf">create</span><span class="p">().</span><span class="nf">build</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ì´ë ‡ê²Œ ë  ê²½ìš° <code class="language-plaintext highlighter-rouge">cookieSpec</code> ì´ default ë¡œ ë“¤ì–´ê°€ë©´ì„œ <code class="language-plaintext highlighter-rouge">org.apache.http.client.protocol.RequestAddCookies</code> í•„í„°ê°€ ë””í´íŠ¸ë¡œ ì¥ì°©ë˜ê³ , ì´ ì¸í„°ì…‰í„°ê°€ RFC6265 ì— ê±¸ë§ëŠ” ì‘ì—…, ì¦‰ <code class="language-plaintext highlighter-rouge">Set-Cookie</code> ë¥¼ ì‘ë‹µìœ¼ë¡œ ë°›ì•˜ì„ ë•Œ ë‹¤ìŒ ë¦¬í€˜ìŠ¤íŠ¸ë¶€í„°ëŠ” cookie ë¥¼ ë„£ì–´ì£¼ëŠ” ì‘ì—…ì„ ì§„í–‰í•œë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">webClient</code> ì—ëŠ” í•´ë‹¹ ì‘ì—…ì„ í•´ì£¼ëŠ” í•„í„°ê°€ ì—†ë‹¤. ì•„ë‹ˆ ëª»ì°¾ì€ê±´ê°€??
ê·¸ë¦¬í•˜ì—¬, ë‚˜ëŠ” ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì€ ì»¤ìŠ¤í…€ ì‘ì—…ì„ í•´ì£¼ì–´ì•¼ í–ˆë‹¤.</p>
<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">private</span> <span class="kd">val</span> <span class="py">myCookies</span> <span class="p">=</span> <span class="nc">ConcurrentHashMap</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">LinkedMultiValueMap</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;&gt;()</span>

<span class="k">fun</span> <span class="nf">a</span><span class="p">()</span> <span class="p">=</span> <span class="n">webClient</span><span class="p">.</span><span class="nf">post</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">uri</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">accept</span><span class="p">(</span><span class="nc">MediaType</span><span class="p">.</span><span class="nc">APPLICATION_JSON</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">headers</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">sessionBasicAuth</span><span class="p">()</span> <span class="p">}</span>
    <span class="p">.</span><span class="nf">cookies</span> <span class="p">{</span> <span class="n">c</span> <span class="p">-&gt;</span> <span class="n">myCookies</span><span class="p">[</span><span class="n">hostAndPort</span><span class="p">]</span><span class="o">?.</span><span class="nf">let</span> <span class="p">{</span> <span class="n">c</span><span class="p">.</span><span class="nf">addAll</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
    <span class="p">.</span><span class="nf">bodyValue</span><span class="p">(</span>
        <span class="nf">mapOf</span><span class="p">(</span>
            <span class="s">"userNo"</span> <span class="n">to</span> <span class="n">userNo</span><span class="p">,</span>
            <span class="s">"message"</span> <span class="n">to</span> <span class="n">message</span><span class="p">,</span>
            <span class="s">"socketId"</span> <span class="n">to</span> <span class="n">socketId</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="p">.</span><span class="nf">exchangeToMono</span> <span class="p">{</span>
        <span class="n">it</span><span class="p">.</span><span class="nf">defaultCookiesWork</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">it</span><span class="p">.</span><span class="nf">bodyToMono</span><span class="p">(</span><span class="kd">object</span> <span class="err">: </span><span class="nc">ParameterizedTypeReference</span><span class="p">&lt;</span><span class="nc">ApiResponse</span><span class="p">&lt;</span><span class="nc">Any</span><span class="p">&gt;&gt;()</span> <span class="p">{})</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="nf">timeout</span><span class="p">(</span><span class="nc">Duration</span><span class="p">.</span><span class="nf">ofMillis</span><span class="p">(</span><span class="n">connectionTimeout</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">isSuccess</span> <span class="p">}</span>

<span class="k">private</span> <span class="k">fun</span> <span class="nc">ClientResponse</span><span class="p">.</span><span class="nf">defaultCookiesWork</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">clientResponse</span> <span class="p">=</span> <span class="k">this</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">clientResponse</span><span class="p">.</span><span class="nf">statusCode</span><span class="p">().</span><span class="n">is2xxSuccessful</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">myCookies</span><span class="p">.</span><span class="nf">compute</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">value</span> <span class="p">-&gt;</span>
            <span class="kd">val</span> <span class="py">map</span> <span class="p">=</span> <span class="n">value</span> <span class="o">?:</span> <span class="nc">LinkedMultiValueMap</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;()</span>
            <span class="n">clientResponse</span><span class="p">.</span><span class="nf">cookies</span><span class="p">().</span><span class="n">keys</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="n">cookieKey</span> <span class="p">-&gt;</span>
                <span class="kd">val</span> <span class="py">cookieValue</span> <span class="p">=</span> <span class="n">clientResponse</span><span class="p">.</span><span class="nf">cookies</span><span class="p">()[</span><span class="n">cookieKey</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cookieValue</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">map</span><span class="p">[</span><span class="n">cookieKey</span><span class="p">]</span> <span class="p">=</span> <span class="n">cookieValue</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">value</span> <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="n">map</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>ì´ê±´ <code class="language-plaintext highlighter-rouge">RequestAddCookies</code> í´ë˜ìŠ¤ë¥¼ ë³´ê³  ì§  ê±´ ì•„ë‹ˆë‹¤. ë‹¤í–‰íˆ <code class="language-plaintext highlighter-rouge">url</code>ì— í•´ë‹¹í•˜ëŠ” ì„œë²„ë“¤ì´ k8s ë°–ì— ìˆì–´ì„œ ì„œë²„ë³„ ë„ë©”ì¸ì´ ë”°ë¡œ ìˆëŠ” ìƒí™©ì´ì–´ì„œ ì´ì •ë„ ì½”ë“œë¡œë„ ê°€ëŠ¥í–ˆì§€ë§Œ, virtual service ë¥¼ í†µí•´ ì—¬ëŸ¬ í†°ìº£ì´ ê°™ì€ ë„ë©”ì¸ìœ¼ë¡œ ëŒê³  ìˆëŠ” í™˜ê²½ì´ë¼ë©´ concurrentHashMap ì˜ í‚¤ë¡œ url ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ ë¨¹íˆì§€ ì•Šì„ ê²ƒì´ë‹¤.</p>

<h3 id="ì•„ì§-í’€ì§€-ëª»í•œ-ë¬¸ì œ">ì•„ì§ í’€ì§€ ëª»í•œ ë¬¸ì œ</h3>
<ol>
  <li>webClient ì—ë„ RFC6265 ìŠ¤í™ì„ ìœ„í•œ í•„í„° (RequestAddCookies ê°™ì€) ê°€ ìˆì„ í…ë°, ê·¸ê±¸ ëª»ì°¾ê² ë‹¤â€¦ ì—†ëŠ”ê±´ê°€??</li>
  <li>setCookieê°€ ë™ì‘í•˜ì§€ ì•Šì•„ì„œ securityContext ì—ì„œ ê¸°ì¡´ ì¸ì¦ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìœ ì§€í•˜ì§€ ì•Šê³  ë§¤ë²ˆ ìƒˆë¡œìš´ ì„¸ì…˜ì„ ìƒì„±í•œë‹¤ë©´ cpu ê°€ í’€ë¡œ ì“°ì¸ë‹¤ëŠ”ê±´ë°, ì´ê²Œ ê·¸ë ‡ê²Œê¹Œì§€ cpu ë¥¼ ë§ì´ ë¨¹ëŠ” ì‘ì—…ì¸ê°€?? <code class="language-plaintext highlighter-rouge">WebSecurityConfigurerAdapter</code> ì— ëŒ€í•œ ë‚´ë¶€ ë™ì‘ì˜ ì´í•´ë„ê°€ ë‚®ì•„ì„œ ì˜ ëª¨ë¥´ê² ë‹¤.</li>
</ol>
:ET