I"É<p>ì‚¬ê±´ì˜ ë°œë‹¨ì€ webflux ë¡œì˜ ì „í™˜ì´ì—ˆë‹¤. Aì„œë²„ -&gt; Bì„œë²„ ì˜ api íë¦„ì„ ê°€ì§€ëŠ” ì‹œìŠ¤í…œì—ì„œ Aì„œë²„ë¥¼ ì›¹í”ŒëŸ­ìŠ¤ë¡œ ì „í™˜í•˜ì—¬ cpu usage ë° Bì„œë²„ í˜¸ì¶œ ë³‘ë ¬ì²˜ë¦¬ë¡œ response time ì„ ì ˆì•½í•˜ë ¤ëŠ” ì·¨ì§€ì˜€ìœ¼ë‚˜â€¦ ë°°í¬ í›„ ì¹´ë‚˜ë¦¬ ìƒíƒœì—ì„œ íŠ¸ë˜í”½ì„ ì¡°ê¸ˆì”© ë„£ê¸° ì‹œì‘í•´ì„œ 20í¼ì„¼íŠ¸ê°€ ë˜ë©´ ì´ë‚´ ì„œí‚·ì´ ì—´ë¦¬ê³  ì¥ì• ê°€ ë‚¬ë‹¤. ì™œì§€â€¦ í•˜ê³  ë¶„ì„í•˜ë‹¤ê°€ ì•Œê²Œëœ ì‚¬ì‹¤ì— ëŒ€í•œ ì •ë¦¬</p>

<h3 id="ë©”íŠ¸ë¦­apm-ìƒ˜í”Œì„-ì—´ì‹¬íˆ-ë¶„ì„">ë©”íŠ¸ë¦­/apm ìƒ˜í”Œì„ ì—´ì‹¬íˆ ë¶„ì„</h3>
<ol>
  <li>íŠ¸ë˜í”½ ì—†ëŠ” ìƒíƒœì—ì„œ ê¸°ëŠ¥ì€ ì •ìƒìˆ˜í–‰ ëœë‹¤.</li>
  <li>Bì„œë²„ì˜ ë¦¬ìŠ¤í°ìŠ¤ê°€ ì—„ì²­ ëŠë ¤ì§€ëŠ” ìƒ˜í”Œì´ ê³„ì† ì°í˜”ë‹¤. requestMapping ë¶€ë¶„ì„ aspectë¡œ ê°ì‹¼ ë¶€ë¶„ì—ì„œ ì°ëŠ” ë¡œê·¸ì— ë‚˜ì˜¨ api ì˜ ì‹¤í–‰ì‹œê°„ì€ ë³€í™”ê°€ ì—†ì—ˆìœ¼ë‹ˆ í†°ìº£ í”„ë ˆì„ì›Œí¬ìª½ì—ì„œ íœë”©ì´ ê±¸ë ¸ìœ¼ë ¤ë‚˜?</li>
  <li>Bì„œë²„ì˜ CPUê°€ ì ì  íŠ€ë”ë‹ˆ 100ì„ ì°ì—ˆê³ , ê·¸ ë•Œë¶€í„° Aì„œë²„ì—ì„œ íƒ€ì„ì•„ì›ƒì´ ë‚˜ë©´ì„œ ì„œí‚·ì´ ì—´ë ¸ë‹¤.</li>
</ol>

<h3 id="ê°€ì„¤ê³¼-ê¸°ê°">ê°€ì„¤ê³¼ ê¸°ê°</h3>
<ol>
  <li>ë³‘ë ¬ì²˜ë¦¬ê°€ ë„ˆë¬´ ë¹ ë¥¸ ì†ë„ë¡œ ë˜ì–´ì„œ Bì„œë²„ê°€ ê²¬ë””ì§€ ëª»í–ˆë‹¤.
    <ul>
      <li>ë³‘ë ¬ì²˜ë¦¬ ë¹¼ê³  ìˆœì°¨ì²˜ë¦¬ í•´ë´ë„ í•´ì†Œ ì•ˆë¨</li>
    </ul>
  </li>
  <li>ì›¹í”ŒëŸ­ìŠ¤ ì „í™˜ í›„ ì–´ë”˜ê°€ ë¸”ë½ë˜ëŠ” ì½”ë“œê°€ ìˆì–´ì„œ, Bì„œë²„ì™€ ë¬´ê´€í•˜ê²Œ Aì„œë²„ì˜ ì˜ëª»ì´ë‹¤.
    <ul>
      <li>ë ˆë””ìŠ¤ ë°©ë¬¸(ReactiveRedisTemplate ì ìš©)ê³¼ api í˜¸ì¶œì´ ì „ë¶€ì—¬ì„œ ë¸”ë½ë  êµ¬ê°„ì´ ì—†ê³ , ìš°ì„  ì € Bì„œë²„ì˜ cpu íŠ€ëŠ” í˜„ìƒì´ ì„¤ëª…ì´ ì•ˆëœë‹¤.</li>
    </ul>
  </li>
  <li>httpClient ì»¤ë„¥ì…˜ í’€ ì„¤ì •ì´ ì˜ëª»ë¼ì„œ ì»¤ë„¥ì…˜ì´ ë§¤ë²ˆ ìƒˆë¡œ ì—°ê²°ë˜ëŠë¼ ê·¸ë¬ë‹¤.
    <ul>
      <li>http/1.1 ìŠ¤í™ì€ ë””í´íŠ¸ê°€ keep-alive ê³ , í˜¹ì‹œ ëª°ë¼ í—¤ë” ë„£ì–´ë„ í•´ê²° ì•ˆëë‹¤.</li>
      <li>Bì„œë²„ì˜ open files ê°€ íŠ€ì§€ ì•Šì•„ì„œ ìš°ì„ ì€ ì•„ë‹Œê±¸ë¡œâ€¦</li>
    </ul>
  </li>
</ol>

<h3 id="ë”¥ë‹¤ì´ë¸Œ">ë”¥ë‹¤ì´ë¸Œ</h3>
<p>í•˜ì—¬, ì´ìœ ë¥¼ ë„ë¬´ì§€ ì•Œ ìˆ˜ ì—†ì–´ ë¡œì»¬ì—ì„œ Aì„œë²„ë¥¼ êµ¬ë²„ì „ìœ¼ë¡œ ì™”ë‹¤ê°”ë‹¤ í•˜ë©° tcp ë¤í”„ë¥¼ ë– ë³¸ ê²°ê³¼â€¦ ë¬¸ì œê°€ ì›¹í”ŒëŸ­ìŠ¤ê°€ ì•„ë‹ˆë¼  <strong><em>http í´ë¼ì´ì–¸íŠ¸ë¥¼ restTemplate -&gt; webClient ë¡œ ë³€í™˜í•œ ë¶€ë¶„</em></strong>ì´ì—ˆìŒì„ ì•Œì•„ëƒˆë‹¤. Bì„œë²„ ìª½ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">Cookie: JSESSIONID=AE0B...</code> í•˜ëŠ” í—¤ë”ê°€ ë“¤ì–´ì˜¤ì§€ ì•Šì€ ê²ƒì´ë‹¤. ì—¥??</p>

<p><a href="https://datatracker.ietf.org/doc/html/rfc6265">RFC-6265</a> ì— ë”°ë¥´ë©´ ë§ˆë•…íˆ ì„œë²„ê°€ ë¦¬ìŠ¤í°ìŠ¤ì— <code class="language-plaintext highlighter-rouge">Set-Cookie</code> í—¤ë”ë¥¼ ë‚´ë ¤ì£¼ë©´ í´ë¼ì´ì–¸íŠ¸ëŠ” ë‹¤ìŒ ìš”ì²­ë¶€í„° ì¿ í‚¤ë¥¼ ë„£ì–´ì„œ ë³´ë‚´ì•¼ í•˜ëŠ”ë°, webClient ëŠ” ì´ ë™ì‘ì´ ì—†ì—ˆë˜ ê²ƒì´ë‹¤.</p>

<pre><code class="language-kt">@RestController
@RequestMapping("/")
class Controller(
    private val webClient: WebClient,
    private val restTemplate: RestTemplate,
) {
    enum class Type {
        REST_TEMPLATE,
        WEB_CLIENT
    }

    @GetMapping("test")
    fun test(
        @RequestParam("type") type: Type,
        @RequestParam("index") index: Int
    ): Map&lt;String, String&gt; {
        val uri = "http://localhost:8080/get-cookie?type=$type"
        val (user, password) = Auth.userPasswordSet[index]

        return when (type) {
            Type.REST_TEMPLATE -&gt; {
                restTemplate.exchange(
                    uri,
                    HttpMethod.GET,
                    HttpEntity(null, HttpHeaders().also { it.setBasicAuth(user, password) }),
                    object : ParameterizedTypeReference&lt;Map&lt;String, String&gt;&gt;() {}
                ).body!!
            }
            Type.WEB_CLIENT -&gt; {
                webClient.get()
                    .uri(uri)
                    .headers { it.setBasicAuth(user, password) }
                    .retrieve()
                    .bodyToMono(object : ParameterizedTypeReference&lt;Map&lt;String, String&gt;&gt;() {})
                    .block()!!
            }
        }
    }

    @GetMapping("get-cookie")
    fun getHeader(
        httpServletRequest: HttpServletRequest,
    ): Map&lt;String, String&gt; {
        return mapOf("Cookie" to (httpServletRequest.cookies?.get(0)?.let { "${it.name}=${it.value}" } ?: "null"))
    }
}

@Configuration
class Security : WebSecurityConfigurerAdapter() {
    override fun configure(http: HttpSecurity) {
        http
            .httpBasic()
            .and()
                .authorizeRequests()
                .antMatchers("/get-cookie")
                .hasAnyRole(*Auth.role.toTypedArray())
    }
    override fun configure(auth: AuthenticationManagerBuilder) {
        val encoder = PasswordEncoderFactories.createDelegatingPasswordEncoder()
        Auth.userPasswordSet.forEachIndexed { index, (user, password) -&gt;
            auth.inMemoryAuthentication()
                .withUser(user).password(encoder.encode(password)).roles(Auth.role[index])
        }
    }
}
</code></pre>
:ET