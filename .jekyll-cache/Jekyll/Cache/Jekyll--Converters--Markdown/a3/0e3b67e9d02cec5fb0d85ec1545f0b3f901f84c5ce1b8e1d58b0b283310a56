I"Š9<p>ëŸ°íƒ€ì„ ì¤‘ì˜ ìë°” ì–´í”Œë¦¬ì¼€ì´ì…˜ì„ í”„ë¡œíŒŒì¼ë§í•´ì„œ ë¬¸ì œì ì„ ì°¾ì•„ë‚´ê³ , ê°œì„ í–ˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apt-get update <span class="o">&amp;&amp;</span><span class="se">\</span>
  apt-get <span class="nb">install</span> <span class="nt">-y</span> wget <span class="o">&amp;&amp;</span><span class="se">\</span>
  <span class="nb">cd</span> /tmp <span class="o">&amp;&amp;</span><span class="se">\</span>
  wget <span class="nt">-q</span> https://github.com/jvm-profiling-tools/async-profiler/releases/download/v2.7/async-profiler-2.7-linux-x64.tar.gz <span class="o">&amp;&amp;</span><span class="se">\</span>
  <span class="nb">tar </span>xzvf async-profiler-2.7-linux-x64.tar.gz <span class="o">&amp;&amp;</span><span class="se">\ </span>
  <span class="nb">cd </span>async-profiler-2.7-linux-x64 <span class="o">&amp;&amp;</span><span class="se">\</span>
  ./profiler.sh <span class="nt">-d</span> 60 <span class="nt">-e</span> cpu,alloc <span class="nt">-f</span> ./<span class="si">$(</span><span class="nb">echo</span> <span class="nv">$APP_NAME</span><span class="si">)</span>-<span class="si">$(</span><span class="nb">echo</span> <span class="nv">$DEPLOY_VERSION</span><span class="si">)</span>.jfr 1
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">-e cpu,alloc</code> ì˜µì…˜ì€ í”„ë¡œíŒŒì¼ë§ ëŒ€ìƒì— cpu clock ì´ë‘ mem alloc ì„ í¬í•¨ì‹œí‚¤ë„ë¡ í•œë‹¤. ë§ˆì§€ë§‰ ì¸ì <code class="language-plaintext highlighter-rouge">1</code>ì´ pid ì´ê³ , ì—¬ëŸ¬ ì˜µì…˜ì€ <a href="https://github.com/async-profiler/async-profiler#profiler-options">ì—¬ê¸°</a> ì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë‹¤.</p>

<p>ë–¨ê¶ˆì§„ jfr ì„ ì ì ˆí•œ í”„ë¡œíŒŒì¼ë§ íˆ´(ì—¬ê¸°ì„  intellij)ìœ¼ë¡œ í™•ì¸í•˜ë©´ ëœë‹¤.</p>

<hr />

<p align="center">
  <br /><img alt="img-name" src="/assets/images/backend/profile_1.png" class="content-image-1" /><br />
  <em>cpu ìƒ˜í”Œ ì „ì²´ 2252ê°œ ì¤‘ 473ê°œë¥¼ ì°¨ì§€í•˜ëŠ” ê²ƒ</em><br />
</p>

<p>ì•„ë‹ˆ ì´ëŸ°â€¦.!! ì´ëŸ° ê²Œ ë‚˜ì™”ë‹¤. <code class="language-plaintext highlighter-rouge">java.time.ZonedDateTime.parse</code> ì—ì„œ ë°œìƒí•˜ëŠ” exception ìƒì„± ì½”ë“œê°€ cpu ì „ì²´ì˜ 20í¼ì„¼íŠ¸ë¥¼ ë¨¹ê³ ìˆì—ˆë‹¤!
í•´ë‹¹ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ì•˜ë‹¤.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">val</span> <span class="py">formatters</span> <span class="p">=</span> <span class="nf">listOf</span><span class="p">(</span><span class="s">"yyyy"</span><span class="p">,</span> <span class="s">"yyyy-MM"</span><span class="p">,</span> <span class="s">"yyyy-MM-dd"</span><span class="p">,</span> <span class="o">..</span><span class="p">.</span> <span class="p">)</span> <span class="c1">// 22ê°€ì§€ í¬ë§·</span>
	<span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="nf">toDateTimeFormatter</span><span class="p">()</span> <span class="p">}</span> 

<span class="k">fun</span> <span class="nf">parse</span><span class="p">(</span><span class="n">dateString</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">ZonedDateTime</span><span class="p">?</span> <span class="p">{</span>
    <span class="n">formatters</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nc">ZonedDateTime</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">dateString</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">null</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ë‹¤ì–‘í•œ í¬ë§·ì˜ ì‹œê°„ì„ íŒŒì‹±í•˜ê¸° ìœ„í•œ ì½”ë“œì˜€ëŠ”ë°, exception ì„ ìƒì„±í•˜ëŠ”ê²ƒ ìì²´ê°€ í° ë¶€í•˜ì˜€ìŒì„ ê°„ê³¼í•˜ì˜€ë‹¤. ê·¸ë¦¬í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³ , ë‚­ë¹„ë˜ë˜ 20í¼ì„¼íŠ¸ì˜ cpu ë¥¼ íšŒìˆ˜í•˜ì˜€ë‹¤.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">parse</span><span class="p">(</span><span class="n">dateString</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">ZonedDateTime</span><span class="p">?</span> <span class="p">{</span>
    <span class="n">formatters</span><span class="p">.</span><span class="nf">forEach</span> <span class="p">{</span> <span class="n">dtf</span> <span class="p">-&gt;</span>
        <span class="kd">val</span> <span class="py">position</span> <span class="p">=</span> <span class="nc">ParsePosition</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">temporalAccessor</span> <span class="p">=</span> <span class="n">dtf</span><span class="p">.</span><span class="nf">parseUnresolved</span><span class="p">(</span><span class="n">dateString</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">temporalAccessor</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">position</span><span class="p">.</span><span class="n">errorIndex</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">&amp;&amp;</span> <span class="n">position</span><span class="p">.</span><span class="n">index</span> <span class="p">==</span> <span class="n">dateString</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nc">ZonedDateTime</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">dateString</span><span class="p">,</span> <span class="n">dtf</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="k">null</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<p align="center">
  <br /><img alt="img-name" src="/assets/images/backend/profile_2.png" class="content-image-1" /><br />
  <em>1494 ìƒ˜í”Œì¤‘ 45ìƒ˜í”Œ, ì•½ 3í¼ì„¼íŠ¸</em><br />
</p>

<p>ì´ê±´ ì½”í‹€ë¦° ì½”ë“œ ê°€ë…ì„±ì„ ë†’ì´ê¸° ìœ„í•´ <code class="language-plaintext highlighter-rouge">trimIndent</code>ë¥¼ ì‚¬ìš©í–ˆë˜ê±´ë°, ì˜ ì •ë¦¬í•˜ì—¬ ì—†ì•´ë‹¤. ê°€ë…ì„±ì€ ìœ ì§€í•˜ë˜ ë¶ˆí•„ìš”í•œ ìì›ì´ ì“°ì´ì§€ ì•Šê²Œ ì¡°ì ˆí–ˆë‹¤.</p>

<hr />

<p align="center">
  <br /><img alt="img-name" src="/assets/images/backend/profile_4.png" class="content-image-1" /><br />
  <br /><img alt="img-name" src="/assets/images/backend/profile_3.png" class="content-image-1" /><br />
  <em>mongodb ì—ì„œ ì“°ëŠ” bson ì˜ ObjectId ë§Œë“¤ ë•Œ ì“°ì´ëŠ” ì½”ë“œ, ìƒ˜í”Œë§ ëœ ë©”ëª¨ë¦¬ì˜ ì•½ 9í¼ì„¼íŠ¸ë¥¼ ì“´ë‹¤.</em><br />
</p>

<p>í•´ë‹¹ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">parseHexString</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">s</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">byte</span><span class="o">[]</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="no">OBJECT_ID_LENGTH</span><span class="o">];</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">b</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="o">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">),</span> <span class="mi">16</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ë¬¸ì œê°€ ë˜ëŠ” ë¶€ë¶„ì€ <code class="language-plaintext highlighter-rouge">s.substring</code> ì´ <code class="language-plaintext highlighter-rouge">b.length</code>ë²ˆ ë§Œí¼, ì¦‰ 12ë²ˆ ë°˜ë³µë˜ëŠ” ê²ƒì´ë‹¤.
<a href="https://www.baeldung.com/java-hexformat">HexFormat</a> ì´ java 17 ì˜ í”¼ì³ë¡œ ë“¤ì–´ì™€ì„œ ìë°” ë²„ì „ì„ ì˜¬ë¦¬ëŠ”ê²Œ ê°€ì¥ ê¹”ë”í•œ í•´ê²°ì±…ì´ì§€ë§Œ, ì´ëŸ°ì €ëŸ° ì´ìœ ë¡œ ê·¸ëŸ¬ì§€ ëª»í•´ bson ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ObjectId í´ë˜ìŠ¤ë¥¼ ìƒˆë¡œ ì‘ì„±í•˜ì—¬ ì‚¬ìš©í–ˆë‹¤. 
ìˆ˜ì •í•œ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fun</span> <span class="nf">parseHexString</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nc">String</span><span class="p">):</span> <span class="nc">ByteArray</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">bytes</span> <span class="p">=</span> <span class="nc">ByteArray</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="n">length</span> <span class="p">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="n">bytes</span><span class="p">.</span><span class="n">indices</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">=</span> <span class="nf">fromHexDigits</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">i</span> <span class="p">*</span> <span class="mi">2</span><span class="p">).</span><span class="nf">toByte</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">bytes</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">fun</span> <span class="nf">fromHexDigits</span><span class="p">(</span><span class="n">string</span><span class="p">:</span> <span class="nc">CharSequence</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">Int</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">high</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="nf">fromHexDigit</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">code</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">low</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="nf">fromHexDigit</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">index</span> <span class="p">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">code</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">high</span> <span class="n">shl</span> <span class="mi">4</span> <span class="n">or</span> <span class="n">low</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">fun</span> <span class="nf">fromHexDigit</span><span class="p">(</span><span class="n">ch</span><span class="p">:</span> <span class="nc">Int</span><span class="p">):</span> <span class="nc">Int</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="py">value</span><span class="p">:</span> <span class="nc">Int</span> <span class="p">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="n">ushr</span> <span class="mi">8</span> <span class="p">==</span> <span class="mi">0</span> <span class="p">&amp;&amp;</span> <span class="nc">DIGITS</span><span class="p">[</span><span class="n">ch</span><span class="p">].</span><span class="nf">also</span><span class="p">{</span><span class="n">value</span> <span class="p">=</span><span class="n">it</span><span class="p">.</span><span class="nf">toInt</span><span class="p">()}&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="p">}</span>
    <span class="k">throw</span> <span class="nc">NumberFormatException</span><span class="p">(</span><span class="s">"not a hexadecimal digit: \""</span> <span class="p">+</span> <span class="n">ch</span><span class="p">.</span><span class="nf">toChar</span><span class="p">()</span> <span class="p">+</span> <span class="s">"\" = "</span> <span class="p">+</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="ë¦¬ì†ŒìŠ¤-ê°œì„ -í™•ì¸">ë¦¬ì†ŒìŠ¤ ê°œì„  í™•ì¸</h3>

<p>ê·¸ ì™¸ì— path matcher ë¥¼ ant path matcher ì—ì„œ path pattern parser ë¡œ ë³€ê²½í•˜ì˜€ê³ , ê¸°íƒ€ ë“±ë“± ìˆ˜ì •í•´ì„œ</p>

<ul>
  <li>cpu ì‚¬ìš©ë¥  30 í¼ì„¼íŠ¸ ì ˆê°</li>
  <li>api response time 20í¼ì„¼íŠ¸ ê°œì„ </li>
  <li>eden space alloc rate 25 í¼ì„¼íŠ¸ ì ˆê°</li>
</ul>

<p>ë¥¼ ë‹¬ì„±í–ˆë‹¤.</p>

:ET