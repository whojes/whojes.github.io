I"<p>사건의 발단은 webflux 로의 전환이었다. A서버 -&gt; B서버 의 api 흐름을 가지는 시스템에서 A서버를 웹플럭스로 전환하여 cpu usage 및 B서버 호출 병렬처리로 response time 을 절약하려는 취지였으나… 배포 후 카나리 상태에서 트래픽을 조금씩 넣기 시작해서 20퍼센트가 되면 이내 서킷이 열리고 장애가 났다. 왜지… 하고 분석하다가 알게된 사실에 대한 정리</p>

<h3 id="메트릭apm-샘플을-열심히-분석">메트릭/apm 샘플을 열심히 분석</h3>
<ol>
  <li>트래픽 없는 상태에서 기능은 정상수행 된다.</li>
  <li>B서버의 리스폰스가 엄청 느려지는 샘플이 계속 찍혔다. requestMapping 부분을 aspect로 감싼 부분에서 찍는 로그에 나온 api 의 실행시간은 변화가 없었으니 톰캣 프레임워크쪽에서 펜딩이 걸렸으려나?</li>
  <li>B서버의 CPU가 점점 튀더니 100을 찍었고, 그 때부터 A서버에서 타임아웃이 나면서 서킷이 열렸다.</li>
</ol>

<h3 id="가설과-기각">가설과 기각</h3>
<ol>
  <li>병렬처리가 너무 빠른 속도로 되어서 B서버가 견디지 못했다.</li>
  <li>웹플럭스 전환 후 어딘가 블락되는 코드가 있어서, B서버와 무관하게 A서버의 잘못이다.</li>
  <li>httpClient 커넥션 풀 설정이 잘못돼서 커넥션이 매번 새로 연결되느라 그랬다.</li>
</ol>
:ET